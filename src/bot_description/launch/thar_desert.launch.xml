<launch>
  <!--
    thar_desert.launch.xml — Thar Desert UGV Simulation
    =====================================================
    Launches:
      1. Gazebo Harmonic server  (headless-rendering to avoid Ogre2 crash)
      2. Gazebo GUI              (connects to running server)
      3. robot_state_publisher   (URDF → TF tree)
      4. ros_gz_sim create       (spawns autobot at corridor centre)
      5. ros_gz_bridge           (GZ ↔ ROS 2 topics)
      6. bot_controller launch   (JSB + forward controllers + Ackermann + odom)

    Usage:
      cd ~/ResOS
      colcon build - -symlink-install
      source install/setup.bash
      ros2 launch bot_description thar_desert.launch.xml
  -->

  <!-- ── Paths ──────────────────────────────────────────────────────────── -->
  <let name="urdf_path"
       value="$(find-pkg-share bot_description)/urdf/bot.urdf.xacro" />
  <let name="world_path"
       value="$(find-pkg-share bot_description)/worlds/thar_desert.sdf" />
  <let name="bridge_cfg"
       value="$(find-pkg-share bot_description)/config/gazebo_bridge.yaml" />
  <let name="rviz_cfg"
       value="$(find-pkg-share bot_description)/config/main.rviz" />

  <!-- ── Gazebo resource paths ──────────────────────────────────────────── -->
  <!-- Workspace root so GZ can find file:// URIs, plus models/ for model:// URIs -->
  <set_env name="GZ_SIM_RESOURCE_PATH"
           value="/home/aditya-pachauri/silent_sentry_ros2:/home/aditya-pachauri/silent_sentry_ros2/models" />
  <!-- gz_ros2_control plugin lives here in Jazzy -->
  <set_env name="GZ_SIM_SYSTEM_PLUGIN_PATH"
           value="/opt/ros/jazzy/lib" />

  <!-- ── 1. Gazebo server (headless-rendering required for sensors) ──────── -->
  <executable
    cmd="gz sim -s -r --headless-rendering $(var world_path)"
    output="screen"
    launch-prefix="" />

  <!-- ── 2. Gazebo GUI (3-second delay so server is ready) ──────────────── -->
  <executable
    cmd="bash -c 'sleep 3 &amp;&amp; gz sim -g'"
    output="screen"
    launch-prefix="" />

  <!-- ── 3. Robot State Publisher ──────────────────────────────────────── -->
  <node pkg="robot_state_publisher" exec="robot_state_publisher"
        output="screen">
    <param name="robot_description"
           value="$(command 'xacro $(var urdf_path)')" />
    <param name="use_sim_time" value="true" />
  </node>

  <!-- ── 4. Spawn robot (ros_gz_sim create waits for world service) ─────── -->
  <!--    Corridor centre: x=-61  y=-32.4  z=60 (20 m above terrain) -->
  <node pkg="ros_gz_sim" exec="create" output="screen"
        launch-prefix="bash -c 'sleep 5; $0 $@'"
        args="-topic robot_description -name autobot -x -61.0 -y -32.4 -z 60.0" />

  <!-- ── 5. ROS ↔ Gazebo bridge ─────────────────────────────────────────── -->
  <node pkg="ros_gz_bridge" exec="parameter_bridge" output="screen"
        launch-prefix="bash -c 'sleep 6; $0 $@'">
    <param name="config_file" value="$(var bridge_cfg)" />
    <param name="use_sim_time" value="true" />
  </node>

  <!-- ── 6. Controllers (spawner waits for /controller_manager) ─────────── -->
  <include file="$(find-pkg-share bot_controller)/launch/bot_controller.launch.py">
    <arg name="use_sim_time" value="True" />
  </include>

  <!-- ── 7. RViz (optional – comment out if not needed) ────────────────── -->
  <!-- <node pkg="rviz2" exec="rviz2" output="screen"
              args="-d $(var rviz_cfg)" /> -->

</launch>
